<!-- 37471237-ba39-4b1d-a002-7dce1435ff2f 3a4646dd-7289-4f8e-af03-2ab950f4ff38 -->
# Enrich LLM Context for Richer Narratives

## Current State Analysis

The `ColonyStateCollector.cs` and `PromptBuilder.cs` currently collect:

| Category | Data Collected | Depth |

|----------|---------------|-------|

| Colony basics | Name, age, season, biome, year | Good |

| Population | Counts (colonists, prisoners) | Basic |

| Colonists | Name, role, 1 trait, health (max 8) | Shallow |

| Resources | Wealth, food status, medicine count | Basic |

| Recent events | Last 5 event labels | Very shallow |

| Current event | Label, faction, threat level | Basic |

---

## Missing Context (All Important)

### Character & Social Data

**1. Colonist Relationships**

- Romantic: married, lovers, ex-lovers
- Family: parents, children, siblings (even off-map)
- Social: friends, rivals, opinions
- Source: `Pawn.relations.DirectRelations` and `Pawn.relations.PotentiallyRelatedPawns`

**2. Pawn-to-Pawn Interactions (NEW)**

- Recent social interactions (deep talks, insults, slights, kind words)
- Romance attempts (successes, rejections)
- Social fights that occurred
- Who interacted with whom and the nature of interaction
- Source: `Pawn.needs.mood.thoughts.memories` for social thoughts, `PlayLog` for interaction records

**3. Recent Individual Activities (NEW)**

- Current job/task each colonist is doing right now
- Recent notable actions:
  - Combat: kills, downs, wounds inflicted
  - Medical: surgeries performed, patients treated, lives saved
  - Crafting: masterwork/legendary items created
  - Construction: buildings completed
  - Social: recruitment attempts, warden interactions
- Source: `Pawn.jobs.curJob`, `Pawn.records` for stats, `Find.PlayLog.AllEntries` for battle log

**4. Colonist Backstories**

- Childhood and adulthood backstory titles
- Reveals origins, skills context, potential narrative hooks
- Source: `Pawn.story.Childhood`, `Pawn.story.Adulthood`

**5. All Colonist Traits**

- Currently limited to 10 hardcoded "notable" traits
- ALL traits matter for personality and narrative
- Source: `Pawn.story.traits.allTraits`

**6. Current Mental State**

- Mood level (percentage)
- Active mental breaks or mental states
- Recent mental break history
- Inspiration states
- Source: `Pawn.needs.mood`, `Pawn.MentalStateDef`, `Pawn.Inspired`

### Colony History & Memory

**7. Colony Death Records**

- Who died, when, cause of death
- CRITICAL for narrative callbacks ("Remember when Mira fell defending the gate...")
- Source: Track in `StoryContext` when colonists die, scan `Find.World.worldPawns`

**8. Full Faction Relations**

- All factions with goodwill values
- Hostile/allied/neutral status
- Past interactions (traded, raided by, gifted)
- Source: `Find.FactionManager.AllFactionsVisible`

**9. Battle/Raid History**

- Major raids survived
- Casualties on both sides
- Who performed heroically
- Source: Track in `StoryContext`, or reconstruct from `PlayLog`

### Environment & Situation

**10. Environment & Conditions**

- Current weather (rain, snow, fog, clear, thunderstorm)
- Time of day (morning, afternoon, evening, night)
- Active game conditions (toxic fallout, eclipse, cold snap, heat wave)
- Current temperature
- Source: `map.weatherManager`, `GenLocalDate`, `map.gameConditionManager`

**11. Detailed Resource Counts**

- Silver, gold, steel, plasteel, uranium, components
- Food types and quantities
- Drug stockpiles
- Source: `map.resourceCounter`, `map.listerThings`

**12. Prisoner Details**

- Names, original factions, health status
- Recruitment progress
- How/when captured
- Source: `map.mapPawns.PrisonersOfColony`

### Infrastructure & Assets

**13. Infrastructure Status**

- Hospital beds count and quality
- Defensive structures (turrets, mortars, traps)
- Research completed (current tech level)
- Power generation capacity
- Source: Building queries, `Find.ResearchManager`

**14. Colony Animals**

- Bonded animals with their bondmate's name
- Working animals (haulers, fighters)
- Trained abilities
- Source: `map.mapPawns.SpawnedColonyAnimals`

**15. Active Threats**

- Ongoing raids or sieges
- Infestations
- Mechanoid clusters on map
- Manhunter packs
- Source: `map.attackTargetsCache`, lord jobs, game conditions

**16. Notable Items**

- Legendary/masterwork weapons and armor (with wielder)
- AI persona cores, artifacts, relics
- Bionic implants installed
- Source: Query `map.listerThings` for quality items, pawn hediffs

**17. Ideology (DLC)**

- Primary memes and precepts if Ideology active
- Affects moral dilemmas significantly
- Ritual history
- Source: `Faction.OfPlayer.ideos` (needs DLC check)

---

## Implementation Approach

### Files to Modify

**1. `ColonyStateCollector.cs`** - Add new collection methods:

```csharp
// Relationships & Social
GetColonistRelationships(Pawn pawn)      // Family, romantic, social
GetRecentInteractions(Pawn pawn)         // NEW: social interactions
GetRecentActivities(Pawn pawn)           // NEW: what they've been doing

// History
GetDeathRecords()
GetAllFactionRelations()
GetBattleHistory()

// Colonist Details
GetColonistBackstory(Pawn pawn)
GetAllTraits(Pawn pawn)
GetMentalState(Pawn pawn)
GetCurrentActivity(Pawn pawn)            // NEW: current job

// Environment
GetEnvironmentContext(Map map)
GetDetailedResources(Map map)
GetActiveThreats(Map map)

// Other
GetPrisonerDetails(Map map)
GetColonyAnimals(Map map)
GetNotableItems(Map map)
GetInfrastructure(Map map)
```

**2. `ColonySnapshot.cs`** - Expand data class significantly:

```csharp
// New fields for comprehensive context
public List<ColonistDetail> ColonistDetails;  // Full colonist info
public List<string> RecentInteractions;       // NEW: pawn interactions
public List<string> RecentActivities;         // NEW: individual actions
public List<string> DeathRecords;
public List<FactionRelationInfo> FactionRelations;
public List<string> BattleHistory;
public EnvironmentInfo Environment;           // Weather, time, conditions
public Dictionary<string, int> Resources;
public List<PrisonerInfo> Prisoners;
public List<string> Animals;
public List<string> ActiveThreats;
public List<string> NotableItems;
public InfrastructureInfo Infrastructure;
```

**3. `StoryContext.cs`** - Track historical data:

```csharp
// Historical tracking (persisted in save)
public List<DeathRecord> ColonistDeaths;
public List<BattleRecord> MajorBattles;
public List<string> RecruitedPawns;
public List<string> SignificantInteractions;  // NEW: memorable social moments
public List<string> HeroicActions;            // NEW: notable individual feats
```

**4. `PromptBuilder.cs`** - Format comprehensive context:

- Include all collected data
- Organize by category for clarity
- No token constraints - send everything relevant

---

## Recommended Implementation Order

1. Pawn interactions + recent activities (NEW - high narrative value)
2. Colonist relationships (character drama)
3. Death records + battle history (story continuity)
4. Faction relations (political context)
5. Backstories + all traits (character depth)
6. Mental state + mood (emotional context)
7. Environment/conditions (atmosphere)
8. Resources + infrastructure (situational)
9. Prisoners, animals, threats, items (completeness)

### To-dos

- [ ] Add full faction relations with goodwill and interaction history
- [ ] Track colonist deaths with cause and date in StoryContext
- [ ] Collect colonist relationships (romantic, family, social)
- [ ] Include colonist childhood/adult backstory titles
- [ ] Add weather, time of day, active conditions to context
- [ ] Add specific resource counts (silver, steel, components)
- [ ] Add prisoner names, factions, and capture context
- [ ] Expand trait collection beyond 10 hardcoded notable traits
- [ ] Add colonist mood levels and mental break history
- [ ] Update PromptBuilder to format enriched context efficiently